<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Global Memory &amp; Shared Memory · Shambles.jl</title><script data-outdated-warner src="../../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Shambles.jl/manual/datamovement/gs/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Shambles.jl</a></span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../../layout/">Layout</a></li><li><input class="collapse-toggle" id="menuitem-2-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2-2"><span class="docs-label">Data Movement</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Global Memory &amp; Shared Memory</a><ul class="internal"><li><a class="tocitem" href="#Code-Explanation"><span>Code Explanation</span></a></li></ul></li></ul></li></ul></li><li><span class="tocitem">API Reference</span><ul><li><a class="tocitem" href="../../../api/layout/">Layout</a></li><li><a class="tocitem" href="../../../api/array/">CuTeArray</a></li><li><a class="tocitem" href="../../../api/tiling/">Tiling</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li><a class="is-disabled">Data Movement</a></li><li class="is-active"><a href>Global Memory &amp; Shared Memory</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Global Memory &amp; Shared Memory</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Shambles.jl/blob/main/docs/src/manual/datamovement/gs.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Copy-Kernel-Tutorial"><a class="docs-heading-anchor" href="#Copy-Kernel-Tutorial">Copy Kernel Tutorial</a><a id="Copy-Kernel-Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Copy-Kernel-Tutorial" title="Permalink"></a></h1><p>This tutorial illustrates the process copying data between global memory and shared memory using <code>Shambles</code>. </p><p>The copy kernel first asynchronously copies data from the global memory to the shared memory and subsequently validates the correctness of the operation by copying the data back from the shared memory to the global memory.</p><p>In this tutorial, we will use the following configuration:</p><ul><li>Array size: 256 x 32 (M x N)</li><li>Block size: 128 x 16</li><li>Thread size: 32 x 8</li></ul><h2 id="Code-Explanation"><a class="docs-heading-anchor" href="#Code-Explanation">Code Explanation</a><a id="Code-Explanation-1"></a><a class="docs-heading-anchor-permalink" href="#Code-Explanation" title="Permalink"></a></h2><p>The device function follows these steps:</p><ol><li>Allocate shared memory using Shambles.SharedMemory.</li><li>Wrap the shared memory with <a href="../../../api/array/#Shambles.CuTeArray"><code>CuTeArray</code></a> with a static layout and destination, and source arrays with dynamic layouts.</li><li>Compute the size of each block in the grid (bM and bN).</li><li>Create local tiles for the destination and source arrays using <a href="../../../api/tiling/#Shambles.local_tile"><code>local_tile</code></a>.</li><li>Partition the local tiles into thread tiles using <a href="../../../api/tiling/#Shambles.local_partition"><code>local_partition</code></a>.</li><li>Asynchronously copy data from the source thread tile to the shared memory thread tile using <a href="../../../api/copy/#Shambles.cucopyto!"><code>cucopyto!</code></a>.</li><li>Synchronize threads using <code>sync_threads</code>.</li><li>Copy data back from the shared memory thread tile to the destination thread tile with <code>cucopyto!</code> again, but under the hood it is using the universal copy method.</li><li>Synchronize threads again using <code>sync_threads</code>.</li></ol><p>The host function tests the copy_kernel function with the following steps:</p><ol><li>Define the dimensions M and N for the source and destination arrays.</li><li>Create random GPU arrays a and b with the specified dimensions using CUDA.rand.</li><li>Define the block and thread layouts using [<code>@Layout</code>] for creating <strong>static</strong> layouts.</li><li>Calculate the number of blocks in the grid using <code>cld</code>. Here we assume the divisibility.</li></ol><pre><code class="language-julia hljs">using Shambles, Test, CUDA

function copy_kernel(M, N, dest, src, blocklayout, threadlayout)
    smem = Shambles.SharedMemory(eltype(dest), cosize(blocklayout))
    cute_smem = CuTeArray(smem, blocklayout)

    cute_dest = CuTeArray(pointer(dest), Layout((M, N), (static(1), M))) # bug: cannot use make_layout((M, N))
    cute_src = CuTeArray(pointer(src), Layout((M, N), (static(1), M)))

    bM = size(blocklayout, 1)
    bN = size(blocklayout, 2)

    blocktile_dest = local_tile(cute_dest, (bM, bN), (Int(blockIdx().x), Int(blockIdx().y)))
    blocktile_src = local_tile(cute_src, (bM, bN), (Int(blockIdx().x), Int(blockIdx().y)))

    threadtile_dest = local_partition(blocktile_dest, threadlayout, Int(threadIdx().x))
    threadtile_src = local_partition(blocktile_src, threadlayout, Int(threadIdx().x))
    threadtile_smem = local_partition(cute_smem, threadlayout, Int(threadIdx().x))

    cucopyto!(threadtile_smem, threadtile_src) 
    sync_threads()
    cucopyto!(threadtile_dest, threadtile_smem)
    sync_threads()
    return nothing
end

function test_copy_async()
    M = 256
    N = 32

    a = CUDA.rand(Float32, M, N)
    b = CUDA.rand(Float32, M, N)

    blocklayout = @Layout((128, 16))
    threadlayout = @Layout((32, 8))

    bM = size(blocklayout, 1)
    bN = size(blocklayout, 2)

    blocks = (cld(M, bM), cld(N, bN))
    threads = Shambles.Static.dynamic(size(threadlayout))

    @cuda blocks=blocks threads=threads copy_kernel(M, N, a, b, blocklayout, threadlayout)
    @test a == b
end

test_copy_async()</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../layout/">« Layout</a><a class="docs-footer-nextpage" href="../../../api/layout/">Layout »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Saturday 29 April 2023 22:08">Saturday 29 April 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
